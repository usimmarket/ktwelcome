<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>KT WELCOME 좌표 매핑 스튜디오 (Pro v2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0f172a; --panel:#111827; --card:#0b1220; --muted:#94a3b8; --accent:#38bdf8; }
  body{margin:0;background:#0a0f1a;color:#e5e7eb;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Apple Color Emoji;}
  header{padding:14px 16px;background:linear-gradient(180deg,#0b1220,#0a0f1a);border-bottom:1px solid #0b2540;display:flex;gap:12px;align-items:center;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:18px;font-weight:700}
  .hint{color:#93c5fd;font-size:12px}
  .wrap{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 56px)}
  aside{border-right:1px solid #0b2540;background:linear-gradient(180deg,#0b1220,#0a0f1a);padding:14px;overflow:auto}
  main{overflow:auto;position:relative}
  .card{background:#0b1220;border:1px solid #0b2540;border-radius:14px;padding:12px;margin-bottom:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:#cbd5e1}
  input[type="number"], input[type="text"], select{background:#0a1628;border:1px solid #113153;color:#e5e7eb;padding:6px 8px;border-radius:8px;font-size:12px;outline:none;width:100%}
  input[type="number"]{width:82px}
  input[type="checkbox"]{transform:translateY(1px)}
  button{background:#132238;border:1px solid #204a7a;color:#e6f6ff;border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer}
  button.primary{background:#0ea5e9;border-color:#38bdf8;color:#00111c}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px}
  .small{font-size:11px;color:#9fb4cf}
  .list{max-height:210px;overflow:auto}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px dashed #25496f;padding:4px 6px;border-radius:999px;background:#0a1628;color:#cfe9ff;font-size:11px;margin:3px 3px 0 0}
  .pill .del{cursor:pointer;color:#93c5fd}
  canvas{display:block;max-width:100%;margin:20px auto;background:#fff;box-shadow:0 0 0 1px #0b2540;image-rendering:pixelated}
  .pageToolbar{position:sticky;top:56px;z-index:3;display:flex;gap:8px;background:#07101c;border-bottom:1px solid #0b2540;padding:8px 12px}
  .cross{position:absolute;pointer-events:none;border-left:1px solid #ef4444;border-top:1px solid #ef4444;width:22px;height:22px;transform:translate(-11px,-11px)}
  .pin{position:absolute;background:#004e78;color:#e6f6ff;border:1px solid #5cc8ff;border-radius:8px;padding:2px 6px;font-size:11px;transform:translate(-50%,-50%);white-space:nowrap}
  .pin .k{color:#9ae6ff}
  .legend{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <h1>KT WELCOME 좌표 매핑 스튜디오 (Pro v2)</h1>
  <div class="hint">1pt = 1px / 템플릿은 <code>/template.pdf</code>로 불러옵니다.</div>
</header>
<div class="wrap">
  <aside>
    <div class="card">
      <div class="row">
        <label>PDF 경로</label>
        <input id="pdfUrl" type="text" placeholder="/template.pdf" value="/template.pdf"/>
        <button id="btnLoad" class="primary">불러오기</button>
      </div>
      <div class="small" style="margin-top:6px">여러 페이지 PDF 지원. 상단 툴바로 페이지 이동.</div>
    </div>

    <div class="card">
      <div class="row"><label><b>텍스트 필드 추가</b></label></div>
      <div class="grid">
        <div><label>key</label><input id="fKey" type="text" placeholder="예: birth"/></div>
        <div><label>x</label><input id="fX" type="number" value="0"/></div>
        <div><label>y</label><input id="fY" type="number" value="0"/></div>
        <div><label>size</label><input id="fSize" type="number" value="10"/></div>
        <div><label>page</label><input id="fPage" type="number" value="1"/></div>
        <div><label>p(=page)</label><input id="fP" type="number" value="1"/></div>
        <div><label>미리보기</label><button id="previewText">미리보기</button></div>
        <div style="align-self:end"><button id="addText" class="primary">추가</button></div>
      </div>
      <div class="small">※ 같은 key를 여러 페이지에 찍으면 저장 시 자동으로 <code>key_p{페이지}</code>로 확장하고 <code>"source":[key]</code>를 넣어줍니다.</div>
    </div>

    <div class="card">
      <div class="row"><label><b>V 체크 옵션(체크박스)</b></label></div>
      <div class="small">각 옵션 위치에 좌표를 찍은 뒤, 값이 해당 옵션일 때 '✓'를 인쇄합니다.</div>
      <div style="height:8px"></div>
      <div class="grid">
        <div><label>join_type:new</label><input data-opt="join_type:new" class="optX" type="number" placeholder="x"/><input data-opt="join_type:new" class="optY" type="number" placeholder="y"/></div>
        <div><label>join_type:port</label><input data-opt="join_type:port" class="optX" type="number"/><input data-opt="join_type:port" class="optY" type="number"/></div>

        <div><label>gender:M</label><input data-opt="gender:M" class="optX" type="number"/><input data-opt="gender:M" class="optY" type="number"/></div>
        <div><label>gender:F</label><input data-opt="gender:F" class="optX" type="number"/><input data-opt="gender:F" class="optY" type="number"/></div>

        <div><label>prevcarrier:SK</label><input data-opt="prevcarrier:SK" class="optX" type="number"/><input data-opt="prevcarrier:SK" class="optY" type="number"/></div>
        <div><label>prevcarrier:LGU+</label><input data-opt="prevcarrier:LG U+" class="optX" type="number"/><input data-opt="prevcarrier:LG U+" class="optY" type="number"/></div>
        <div><label>prevcarrier:MVNO</label><input data-opt="prevcarrier:MVNO" class="optX" type="number"/><input data-opt="prevcarrier:MVNO" class="optY" type="number"/></div>

        <div><label>prefsms:EN</label><input data-opt="prefsms:EN" class="optX" type="number"/><input data-opt="prefsms:EN" class="optY" type="number"/></div>
        <div><label>prefsms:CN</label><input data-opt="prefsms:CN" class="optX" type="number"/><input data-opt="prefsms:CN" class="optY" type="number"/></div>
        <div><label>prefsms:VN</label><input data-opt="prefsms:VN" class="optX" type="number"/><input data-opt="prefsms:VN" class="optY" type="number"/></div>
        <div><label>prefsms:RU</label><input data-opt="prefsms:RU" class="optX" type="number"/><input data-opt="prefsms:RU" class="optY" type="number"/></div>
        <div><label>prefsms:KR</label><input data-opt="prefsms:KR" class="optX" type="number"/><input data-opt="prefsms:KR" class="optY" type="number"/></div>

        <div><label>method:bank</label><input data-opt="method:bank" class="optX" type="number"/><input data-opt="method:bank" class="optY" type="number"/></div>
        <div><label>method:card</label><input data-opt="method:card" class="optX" type="number"/><input data-opt="method:card" class="optY" type="number"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <label>공통 font size</label><input id="optSize" type="number" value="11"/>
        <label>page</label><input id="optPage" type="number" value="1"/>
        <button id="previewOpt">체크 미리보기</button>
      </div>
    </div>

    <div class="card">
      <div class="row"><label><b>필드 목록</b></label></div>
      <div id="fieldList" class="list"></div>
      <div class="row" style="margin-top:8px">
        <button id="exportJson" class="primary">매핑 JSON 내보내기</button>
        <button id="importJson">가져오기</button>
        <input type="file" id="importFile" accept=".json" style="display:none"/>
      </div>
      <div class="small">파일명 제안: <code>KT_mapping_legacy_names.json</code></div>
    </div>

    <div class="card">
      <div class="legend">
        <span class="pill"><span class="k">●</span> 좌클릭: 좌표 찍기</span>
        <span class="pill"><span class="k">◆</span> Shift+드래그: 확대</span>
        <span class="pill"><span class="k">＋</span> 마우스휠: 확대/축소</span>
      </div>
    </div>
  </aside>

  <main>
    <div class="pageToolbar">
      <button id="prev">◀ 이전</button>
      <div id="pageInfo" style="min-width:120px">Page 1 / 1</div>
      <button id="next">다음 ▶</button>
      <div style="flex:1"></div>
      <div>좌표: <span id="cursor">- , -</span></div>
    </div>
    <div id="stage" style="position:relative;padding:12px">
      <canvas id="pdfCanvas" width="595" height="842"></canvas>
      <div id="cross" class="cross" style="display:none"></div>
    </div>
  </main>
</div>

<!-- pdf.js CDN (Netlify 배포 환경에서 로드됨) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
let pdfDoc=null, pageNum=1, totalPages=1, scale=1.35;
const canvas=document.getElementById('pdfCanvas');
const ctx=canvas.getContext('2d');
const cross=document.getElementById('cross');
const cursor=document.getElementById('cursor');
const pins=[]; // {key,x,y,size,page,type:'text'|'v', label}
const optMap={}; // "group:value" -> {x,y,size,page}

function $(s){return document.querySelector(s)}
function $all(s){return Array.from(document.querySelectorAll(s))}

async function loadPDF(url){
  const loadingTask = window['pdfjsLib'].getDocument(url);
  pdfDoc = await loadingTask.promise;
  totalPages = pdfDoc.numPages;
  pageNum = Math.min(Math.max(1, pageNum), totalPages);
  await renderPage(pageNum);
  updatePageInfo();
}

async function renderPage(num){
  const page = await pdfDoc.getPage(num);
  const viewport = page.getViewport({scale});
  canvas.width = Math.round(viewport.width);
  canvas.height = Math.round(viewport.height);
  const renderContext={canvasContext:ctx, viewport};
  await page.render(renderContext).promise;
  redrawPins();
}

function updatePageInfo(){
  $("#pageInfo").textContent = `Page ${pageNum} / ${totalPages}`;
}

$("#btnLoad").addEventListener('click',()=>loadPDF($("#pdfUrl").value || '/template.pdf'));
$("#prev").addEventListener('click',()=>{ if(pageNum>1){pageNum--; renderPage(pageNum); updatePageInfo();} });
$("#next").addEventListener('click',()=>{ if(pageNum<totalPages){pageNum++; renderPage(pageNum); updatePageInfo();} });

canvas.addEventListener('mousemove',(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=Math.round((e.clientX-rect.left));
  const y=Math.round((e.clientY-rect.top));
  cursor.textContent = x+", "+y;
  cross.style.left = x+'px';
  cross.style.top = y+'px';
  cross.style.display = 'block';
});
canvas.addEventListener('mouseleave',()=>cross.style.display='none');

canvas.addEventListener('click',(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=Math.round((e.clientX-rect.left));
  const y=Math.round((e.clientY-rect.top));
  addTextPin({key:$("#fKey").value||'apply_date', x,y, size:+$("#fSize").value||10, page:pageNum, p:pageNum});
  refreshFieldList();
  redrawPins();
});

function addTextPin(obj){
  pins.push({type:'text', ...obj, label:`${obj.key} (x${obj.x}, y${obj.y}, s${obj.size}, p${obj.page})`});
}
function addVPin(group,value,x,y,size,page){
  pins.push({type:'v', key:`${group}:${value}`, x,y,size,page, label:`✓ ${group}:${value} (x${x}, y${y}, s${size}, p${page})`});
}

function redrawPins(){
  // draw labels
  const stage=$("#stage");
  stage.querySelectorAll('.pin').forEach(n=>n.remove());
  for(const p of pins){
    if(p.page!==pageNum) continue;
    const el=document.createElement('div');
    el.className='pin';
    el.style.left=p.x+'px'; el.style.top=p.y+'px';
    el.innerHTML=`<span class="k">${p.type==='v'?'✓':'●'}</span> ${p.label}`;
    stage.appendChild(el);
  }
}

function refreshFieldList(){
  const box=$("#fieldList"); box.innerHTML='';
  pins.forEach((p,i)=>{
    const line=document.createElement('div');
    line.className='pill';
    line.innerHTML=`<span>${p.label}</span> <span class="del" data-i="${i}">삭제</span>`;
    box.appendChild(line);
  });
  box.querySelectorAll('.del').forEach(btn=>btn.addEventListener('click',(e)=>{
    const idx=+e.target.dataset.i; pins.splice(idx,1); refreshFieldList(); redrawPins();
  }));
}

// --- Preview / Add Text ---
$("#previewText").addEventListener('click',()=>{
  const x=+$("#fX").value||0, y=+$("#fY").value||0, size=+$("#fSize").value||10, page=+$("#fPage").value||pageNum;
  addTextPin({key:$("#fKey").value||'apply_date', x,y,size,page,p:page});
  refreshFieldList(); redrawPins();
});
$("#addText").addEventListener('click',()=>{
  const x=+$("#fX").value||0, y=+$("#fY").value||0, size=+$("#fSize").value||10, page=+$("#fPage").value||pageNum;
  addTextPin({key:$("#fKey").value||'apply_date', x,y,size,page,p:page});
  refreshFieldList(); redrawPins();
});

// --- V options ---
$("#previewOpt").addEventListener('click',()=>{
  const size=+$("#optSize").value||11, page=+$("#optPage").value||pageNum;
  document.querySelectorAll('.optX').forEach(xInput=>{
    const key=xInput.dataset.opt;
    const yInput=document.querySelector(`.optY[data-opt="${key}"]`);
    const x=+xInput.value||0, y=+yInput.value||0;
    if(x && y){
      addVPin(key.split(':')[0], key.split(':')[1], x,y,size,page);
    }
  });
  refreshFieldList(); redrawPins();
});

// --- Import / Export ---
$("#exportJson").addEventListener('click',()=>{
  // collapse duplicate text keys by page -> key_p{page} with "source":[key]
  const grouped = {};
  const out=[];
  for(const p of pins){
    if(p.type==='text'){
      const newKey = p.key + `_p${p.page}`;
      out.push({ [newKey]: { x:p.x, y:p.y, size:p.size, page:p.page, source:[p.key] } });
    }else if(p.type==='v'){
      // produce under "vmap" block
      if(!grouped['vmap']) grouped['vmap']={};
      grouped['vmap'][p.key] = { x:p.x, y:p.y, size:p.size, page:p.page };
    }
  }
  const result = { fields: Object.assign({}, ...out), vmap: grouped['vmap']||{} };
  const blob=new Blob([JSON.stringify(result,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='KT_mapping_legacy_names.json';
  a.click();
});

$("#importJson").addEventListener('click',()=>$("#importFile").click());
$("#importFile").addEventListener('change', async (e)=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text();
  try{
    const obj=JSON.parse(text);
    pins.length=0;
    if(obj.fields){
      for(const [k,v] of Object.entries(obj.fields)){
        addTextPin({key:k.replace(/_p\d+$/,''), x:+v.x, y:+v.y, size:+v.size, page:+(v.page||v.p||1), p:+(v.page||v.p||1)});
      }
    }
    if(obj.vmap){
      for(const [k,v] of Object.entries(obj.vmap)){
        const [g,val]=k.split(':');
        addVPin(g,val, +v.x, +v.y, +v.size, +(v.page||1));
      }
    }
    refreshFieldList(); redrawPins();
    alert('가져오기 완료');
  }catch(err){
    alert('JSON 파싱 오류: '+err.message);
  }
});

// init
loadPDF('/template.pdf').catch(()=>{});
</script>
</body>
</html>
