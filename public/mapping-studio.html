<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF 1:1 좌표 매핑 스튜디오 v2</title>
<style>
  :root{--bg:#0b1220;--panel:#0a1628;--card:#0e1a2e;--line:#153a59;--accent:#38bdf8;--text:#e5f2ff;--muted:#9fb4cf;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.55 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
  header{position:sticky;top:0;z-index:6;display:flex;gap:12px;align-items:center;padding:10px 12px;background:#07101c;border-bottom:1px solid #0b2540}
  h1{font-size:15px;margin:0}
  .grid{display:grid;grid-template-columns:360px 1fr 360px;min-height:calc(100vh - 48px)}
  aside, aside.right{padding:12px;border-right:1px solid #0b2540;background:linear-gradient(180deg,#0b1220,#0a0f1a);overflow:auto}
  aside.right{border-left:1px solid #0b2540;border-right:none}
  main{position:relative;overflow:auto}
  .card{background:#0e1a2e;border:1px solid #153a59;border-radius:12px;padding:10px;margin:0 0 12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="number"],input[type="file"],select,textarea{background:#091627;border:1px solid #143252;color:var(--text);border-radius:8px;padding:6px 8px}
  input[type="number"]{width:90px}
  textarea{width:100%;min-height:72px}
  button{background:#0f2742;border:1px solid #21466e;color:#e6f6ff;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:12px}
  button.primary{background:#0ea5e9;border-color:#36bffa;color:#01131e}
  .list{max-height:220px;overflow:auto;border:1px solid #153a59;border-radius:10px;padding:6px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px dashed #2a517b;background:#091a2d;color:#d7eeff;padding:4px 6px;border-radius:999px;font-size:11px;margin:3px 3px 0 0}
  .toolbar{position:sticky; top:0; z-index:5; display:flex; gap:10px; align-items:center; padding:8px 12px; background:#07101c; border-bottom:1px solid #0b2540}
  .stage{position:relative;padding:12px}
  canvas{display:block;background:#fff;box-shadow:0 0 0 1px #0b2540;margin-top:16px}
  .pin{position:absolute;pointer-events:none;background:#004e78;color:#e6f6ff;border:1px solid #5cc8ff;border-radius:8px;padding:2px 6px;font-size:11px;transform:translate(-50%,-100%);white-space:nowrap}
  .pin.sel{background:#0ea5e9;color:#00111c;border-color:#8be4ff}
  .cross{position:absolute;pointer-events:none;border-left:1px solid #ef4444;border-top:1px solid #ef4444;width:22px;height:22px;transform:translate(-11px,-11px)}
  .err{background:#3b1d1d;border:1px solid #7a2b2b;color:#ffdcdc;padding:8px;border-radius:8px;margin:8px 0;display:none;white-space:pre-wrap}
  .muted{color:#9fb4cf;font-size:12px}
  .kbd{display:inline-block;border:1px solid #2a517b;background:#0d2745;padding:0 6px;border-radius:6px;margin-left:6px}
</style>
</head>
<body>
<header>
  <h1>PDF 1:1 좌표 매핑 스튜디오 v2</h1>
  <div class="muted">· 1pt = 1px · PDF 좌표 그대로 · ↑↓←→ 미세 이동 <span class="kbd">1pt</span></div>
</header>

<div class="grid">
  <!-- LEFT: sources + fields + selection -->
  <aside>
    <div class="card">
      <div><b>PDF 불러오기</b></div>
      <div class="row" style="margin-top:6px">
        <input id="pdfUrl" type="text" placeholder="/template.pdf" value="/template.pdf" style="flex:1">
        <button id="btnLoadUrl" class="primary">URL</button>
      </div>
      <div class="row">
        <input id="pdfFile" type="file" accept="application/pdf" style="flex:1">
        <button id="btnLoadFile">로컬</button>
      </div>
      <div id="errPdf" class="err"></div>
    </div>

    <div class="card">
      <div><b>index.html 불러오기 → 필드 목록 구성</b></div>
      <div class="row" style="margin-top:6px">
        <input id="htmlUrl" type="text" placeholder="/index.html" style="flex:1">
        <button id="btnHtmlUrl">URL</button>
      </div>
      <div class="row">
        <input id="htmlFile" type="file" accept=".html,text/html" style="flex:1">
        <button id="btnHtmlFile">로컬</button>
      </div>
      <div class="muted">input/select/textarea 등의 name을 자동 수집해 좌표키로 활용</div>
      <div id="errHtml" class="err"></div>
      <div class="list" id="fieldList"></div>
    </div>

    <div class="card">
      <div><b>좌표 찍기 / 선택</b></div>
      <div class="row" style="margin-top:6px">
        <label>page</label><input id="page" type="number" value="1">
        <label>size</label><input id="size" type="number" value="10">
      </div>
      <div class="row">
        <label>key</label><input id="key" type="text" placeholder="필드명 혹은 자유 입력" style="flex:1">
        <button id="arm" class="primary">캔버스 클릭으로 좌표 찍기</button>
      </div>
      <div class="row">
        <label>X</label><input id="selX" type="number">
        <label>Y</label><input id="selY" type="number">
        <button id="applyXY">적용</button>
      </div>
      <div class="row">
        <button id="nUp">↑</button><button id="nDn">↓</button>
        <button id="nLt">←</button><button id="nRt">→</button>
        <div class="muted">· 선택 핀을 1pt씩 이동</div>
      </div>
      <div class="row">
        <button id="btnDelete">선택 삭제</button>
        <button id="btnDup">선택 복제</button>
      </div>
      <div class="row">
        <button id="export">JSON 내보내기</button>
        <input id="fileJson" type="file" accept=".json" style="display:none">
        <button id="import">가져오기</button>
      </div>
    </div>
  </aside>

  <!-- CENTER: canvas -->
  <main>
    <div class="toolbar">
      <button id="prev">◀ 이전</button>
      <div id="pageInfo">Page 0 / 0</div>
      <button id="next">다음 ▶</button>
      <div style="flex:1"></div>
      <label class="muted"><input id="showOnlyThisPage" type="checkbox" checked> 이 페이지 핀만 표시</label>
      <div>좌표: <span id="cursor">- , -</span></div>
    </div>
    <div id="stage" class="stage">
      <canvas id="canvas" width="595" height="842"></canvas>
      <div id="cross" class="cross" style="display:none"></div>
    </div>
  </main>

  <!-- RIGHT: v-check + fixed labels -->
  <aside class="right">
    <div class="card">
      <div><b>체크박스(vmap)</b></div>
      <div class="row" style="margin-top:6px">
        <label>opt</label><input id="optKey" type="text" placeholder="예: join_type:new" style="flex:1">
      </div>
      <div class="row">
        <label>x</label><input id="optX" type="number">
        <label>y</label><input id="optY" type="number">
        <label>size</label><input id="optSize" type="number" value="11">
        <label>page</label><input id="optPage" type="number" value="1">
      </div>
      <div class="row">
        <button id="addOpt">추가</button>
        <button id="listOpt">목록</button>
      </div>
      <div id="listVmap" class="list" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div><b>고정 라벨 (fixed_flags)</b></div>
      <div class="row" style="margin-top:6px">
        <label>label</label><input id="fixLabel" type="text" placeholder="국제전화차단" style="flex:1">
      </div>
      <div class="row">
        <label>x</label><input id="fixX" type="number">
        <label>y</label><input id="fixY" type="number">
        <label>size</label><input id="fixSize" type="number" value="10">
        <label>page</label><input id="fixPage" type="number" value="1">
      </div>
      <div class="row">
        <button id="addFix">추가</button>
        <button id="listFix">목록</button>
      </div>
      <div id="listFixes" class="list" style="margin-top:6px"></div>
    </div>
  </aside>
</div>

<!-- PDF.js (library + worker) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if (window['pdfjsLib']) { pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"; }</script>

<script>
(function(){
  let pdfDoc=null, curPage=0, total=0;
  const c=document.getElementById('canvas'), ctx=c.getContext('2d'), stage=document.getElementById('stage');
  const cursor=document.getElementById('cursor'), cross=document.getElementById('cross');
  const pins=[]; /* {type:'text'|'v'|'fix', key?, label?, x,y,size,page} */
  let armed=false, selectedIndex=-1;

  const $=s=>document.querySelector(s);
  const $$=(s)=>Array.from(document.querySelectorAll(s));
  const showOnlyThisPageEl=$("#showOnlyThisPage");

  function setInfo(){ $("#pageInfo").textContent=`Page ${curPage} / ${total}`; }

  function errBox(id,msg){ const el=$(id); el.style.display='block'; el.textContent=String(msg||'Unknown error'); console.error(msg); }
  function clearErr(id){ const el=$(id); el.style.display='none'; el.textContent=''; }

  async function loadPdfFromUrl(url){
    try{
      clearErr('#errPdf');
      const loading=window['pdfjsLib'].getDocument({url});
      pdfDoc=await loading.promise; total=pdfDoc.numPages; curPage=1; await render(curPage); setInfo();
    }catch(e){ errBox('#errPdf','PDF URL 로드 실패: '+(e&&e.message?e.message:e)); }
  }
  async function loadPdfFromFile(file){
    try{
      clearErr('#errPdf');
      const buf=new Uint8Array(await file.arrayBuffer());
      const loading=window['pdfjsLib'].getDocument({data:buf});
      pdfDoc=await loading.promise; total=pdfDoc.numPages; curPage=1; await render(curPage); setInfo();
    }catch(e){ errBox('#errPdf','로컬 PDF 로드 실패: '+(e&&e.message?e.message:e)); }
  }
  async function render(n){
    try{
      if(!pdfDoc) return;
      const p=await pdfDoc.getPage(n);
      const vp=p.getViewport({scale:1});
      c.width=Math.round(vp.width); c.height=Math.round(vp.height);
      await p.render({canvasContext:ctx,viewport:vp}).promise;
      drawPins();
    }catch(e){ errBox('#errPdf','렌더링 오류: '+(e&&e.message?e.message:e)); }
  }

  function drawPins(){
    stage.querySelectorAll('.pin').forEach(n=>n.remove());
    const only=showOnlyThisPageEl.checked;
    pins.forEach((p,i)=>{
      if(only && p.page!==curPage) return;
      const el=document.createElement('div'); el.className='pin'+(i===selectedIndex?' sel':'');
      el.style.left=p.x+'px'; el.style.top=p.y+'px';
      el.textContent = p.type==='v' ? `✓ ${p.key}` :
                       p.type==='fix' ? `[${p.label}]` :
                       p.key;
      stage.appendChild(el);
    });
  }

  // Mouse helpers
  c.addEventListener('mousemove',e=>{
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    cursor.textContent=`${x}, ${y}`; cross.style.left=x+'px'; cross.style.top=y+'px'; cross.style.display='block';
  });
  c.addEventListener('mouseleave',()=>cross.style.display='none');

  // Pin placement
  c.addEventListener('click',e=>{
    if(!armed) return;
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    const key=$("#key").value.trim()||'field'; const size=+$("#size").value||10; const page=+$("#page").value||curPage||1;
    pins.push({type:'text', key, x,y,size,page});
    selectedIndex=pins.length-1; armed=false; $("#arm").textContent='캔버스 클릭으로 좌표 찍기';
    drawPins();
  });

  // Select nearest on stage click
  stage.addEventListener('click',e=>{
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    let best=-1, bestD=Infinity;
    pins.forEach((p,i)=>{
      if(showOnlyThisPageEl.checked && p.page!==curPage) return;
      const dx=p.x-x, dy=p.y-y; const d=dx*dx+dy*dy;
      if(d<bestD){best=i; bestD=d;}
    });
    if(best>=0){ selectedIndex=best; $("#selX").value=pins[best].x; $("#selY").value=pins[best].y; $("#page").value=pins[best].page; $("#size").value=pins[best].size; $("#key").value=pins[best].key||''; drawPins(); }
  }, true);

  // Nudge & apply
  function nudge(dx,dy){ if(selectedIndex<0) return; const p=pins[selectedIndex]; p.x+=dx; p.y+=dy; $("#selX").value=p.x; $("#selY").value=p.y; drawPins(); }
  $("#nUp").addEventListener('click',()=>nudge(0,-1)); $("#nDn").addEventListener('click',()=>nudge(0,1));
  $("#nLt").addEventListener('click',()=>nudge(-1,0)); $("#nRt").addEventListener('click',()=>nudge(1,0));
  window.addEventListener('keydown',e=>{ if(e.key==='ArrowUp') nudge(0,-1); if(e.key==='ArrowDown') nudge(0,1); if(e.key==='ArrowLeft') nudge(-1,0); if(e.key==='ArrowRight') nudge(1,0); });
  $("#applyXY").addEventListener('click',()=>{ if(selectedIndex<0) return; const p=pins[selectedIndex]; p.x=+$("#selX").value||p.x; p.y=+$("#selY").value||p.y; p.page=+$("#page").value||p.page; p.size=+$("#size").value||p.size; p.key=$("#key").value||p.key; drawPins(); });

  // Delete & duplicate
  $("#btnDelete").addEventListener('click',()=>{ if(selectedIndex<0) return; pins.splice(selectedIndex,1); selectedIndex=-1; drawPins(); });
  $("#btnDup").addEventListener('click',()=>{ if(selectedIndex<0) return; const p=pins[selectedIndex]; pins.push({...p}); drawPins(); });

  // Import / Export JSON
  $("#import").addEventListener('click',()=>$("#fileJson").click());
  $("#fileJson").addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const text=await f.text(); const obj=JSON.parse(text);
      pins.length=0;
      if(obj.fields){ for(const [k,v] of Object.entries(obj.fields)){
        const base=(v.source && v.source[0]) || k.replace(/_p\\d+(_\\d+)?$/,'');
        pins.push({type:(v.type==='fixed'?'fix':'text'), key:base, x:+v.x, y:+v.y, size:+(v.size||10), page:+(v.page||1)});
      }}
      if(obj.vmap){ for(const [k,v] of Object.entries(obj.vmap)){
        pins.push({type:'v', key:k, x:+v.x, y:+v.y, size:+(v.size||11), page:+(v.page||1)});
      }}
      if(obj.fixed_flags && obj.fixed_flags.intl_roaming_block){
        for(const v of obj.fixed_flags.intl_roaming_block){
          pins.push({type:'fix', label:v.label||'적용', x:+v.x, y:+v.y, size:+(v.size||10), page:+(v.page||1)});
        }
      }
      alert('가져오기 완료'); drawPins();
    }catch(e){ errBox('#errPdf','JSON 파싱 오류: '+(e&&e.message?e.message:e)); }
  });

  $("#export").addEventListener('click',()=>{
    const fields={}, vmap={}, fixed={intl_roaming_block:[]};
    pins.forEach((p,idx)=>{
      if(p.type==='v') vmap[p.key]={x:p.x,y:p.y,size:p.size,page:p.page};
      else if(p.type==='fix') fixed.intl_roaming_block.push({label:p.label||'적용',x:p.x,y:p.y,size:p.size,page:p.page});
      else { const key=`${(p.key||='field')}_p${p.page}_${idx+1}`; fields[key]={x:p.x,y:p.y,size:p.size,page:p.page,source:[p.key],type:'text'}; }
    });
    const json={ fields, vmap, fixed_flags: fixed };
    const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='KT_mapping_legacy_names.json'; a.click();
  });

  // Right panel lists re-render when toggle changes
  $("#showOnlyThisPage").addEventListener('change',()=>{ drawPins(); renderVmapList(); renderFixList(); });

  // vmap/fix list renderers
  function renderVmapList(){
    const el=$("#listVmap"); el.innerHTML=''; const only=$("#showOnlyThisPage").checked;
    pins.forEach(p=>{ if(p.type!=='v') return; if(only && p.page!==curPage) return; const d=document.createElement('div'); d.className='pill'; d.textContent=`${p.key} @(${p.x},${p.y}) p${p.page}`; el.appendChild(d); });
  }
  function renderFixList(){
    const el=$("#listFixes"); el.innerHTML=''; const only=$("#showOnlyThisPage").checked;
    pins.forEach(p=>{ if(p.type!=='fix') return; if(only && p.page!==curPage) return; const d=document.createElement('div'); d.className='pill'; d.textContent=`[${p.label}] @(${p.x},${p.y}) p${p.page}`; el.appendChild(d); });
  }
  $("#addOpt").addEventListener('click',()=>{
    const opt=$("#optKey").value.trim(); if(!opt) return alert('opt (예: join_type:new)를 입력하세요.');
    const x=+$("#optX").value, y=+$("#optY").value, size=+($("#optSize").value||11), page=+($("#optPage").value||1);
    pins.push({type:'v', key:opt, x,y,size,page}); drawPins(); renderVmapList();
  });
  $("#listOpt").addEventListener('click',renderVmapList);
  $("#addFix").addEventListener('click',()=>{
    const label=$("#fixLabel").value.trim(); if(!label) return alert('label을 입력하세요.');
    const x=+$("#fixX").value, y=+$("#fixY").value, size=+($("#fixSize").value||10), page=+($("#fixPage").value||1);
    pins.push({type:'fix', label, x,y,size,page}); drawPins(); renderFixList();
  });
  $("#listFix").addEventListener('click',renderFixList);

  // index.html loaders
  $("#btnHtmlUrl").addEventListener('click',async ()=>{
    const url=$("#htmlUrl").value; if(!url) return alert('index.html URL을 입력하세요.');
    try{
      clearErr('#errHtml');
      const res=await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status);
      const text=await res.text(); buildFieldListFromHtml(text);
    }catch(e){ errBox('#errHtml','index.html URL 로드 실패: '+(e&&e.message?e.message:e)); }
  });
  $("#btnHtmlFile").addEventListener('click',async ()=>{
    const f=$("#htmlFile").files[0]; if(!f) return alert('index.html 파일을 선택하세요.');
    try{
      clearErr('#errHtml');
      const text=await f.text(); buildFieldListFromHtml(text);
    }catch(e){ errBox('#errHtml','index.html 로컬 로드 실패: '+(e&&e.message?e.message:e)); }
  });
  function buildFieldListFromHtml(htmlText){
    const parser=new DOMParser();
    const doc=parser.parseFromString(htmlText,'text/html');
    const names=new Set();
    doc.querySelectorAll('input[name], select[name], textarea[name]').forEach(el=>{ const nm=el.getAttribute('name'); if(nm) names.add(nm); });
    const list=$("#fieldList"); list.innerHTML='';
    if(!names.size){ list.innerHTML='<div class="muted">name을 가진 입력 항목이 없습니다.</div>'; return; }
    Array.from(names).sort().forEach(nm=>{
      const row=document.createElement('div'); row.className='row';
      const btn=document.createElement('button'); btn.textContent='+'; btn.title='이 키로 좌표 찍기 활성화';
      btn.addEventListener('click',()=>{ $("#key").value=nm; $("#arm").click(); });
      const lab=document.createElement('div'); lab.textContent=nm; lab.style.flex='1';
      row.appendChild(btn); row.appendChild(lab); list.appendChild(row);
    });
  }

  // General toolbar
  $("#btnLoadUrl").addEventListener('click',()=>loadPdfFromUrl($("#pdfUrl").value||'/template.pdf'));
  $("#btnLoadFile").addEventListener('click',()=>{ const f=$("#pdfFile").files[0]; if(!f) return alert('PDF 파일을 선택하세요.'); loadPdfFromFile(f); });
  $("#arm").addEventListener('click',()=>{ armed=!armed; $("#arm").textContent = armed ? '좌표 찍기: ON' : '캔버스 클릭으로 좌표 찍기'; });
  $("#prev").addEventListener('click',()=>{ if(!pdfDoc) return; if(curPage>1){ curPage--; render(curPage); setInfo(); } });
  $("#next").addEventListener('click',()=>{ if(!pdfDoc) return; if(curPage<total){ curPage++; render(curPage); setInfo(); } });
  $("#showOnlyThisPage").addEventListener('change',()=>{ drawPins(); });

  setInfo();
})();</script>
</body>
</html>
