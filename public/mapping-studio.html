<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF 1:1 좌표 매핑 스튜디오</title>
<style>
  :root{--bg:#0b1220;--panel:#0a1628;--card:#0e1a2e;--line:#153a59;--accent:#38bdf8;--text:#e5f2ff;--muted:#9fb4cf;}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:13px/1.55 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;display:flex;gap:12px;align-items:center;padding:10px 12px;background:#07101c;border-bottom:1px solid #0b2540}
  h1{font-size:15px;margin:0}
  .wrap{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 48px)}
  aside{padding:12px;border-right:1px solid #0b2540;background:linear-gradient(180deg,#0b1220,#0a0f1a);overflow:auto}
  main{position:relative;overflow:auto}
  .card{background:#0e1a2e;border:1px solid #153a59;border-radius:12px;padding:10px;margin:0 0 12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="number"],input[type="file"]{background:#091627;border:1px solid #143252;color:var(--text);border-radius:8px;padding:6px 8px}
  input[type="number"]{width:90px}
  button{background:#0f2742;border:1px solid #21466e;color:#e6f6ff;border-radius:10px;padding:8px 10px;cursor:pointer;font-size:12px}
  button.primary{background:#0ea5e9;border-color:#36bffa;color:#01131e}
  .pin{position:absolute;pointer-events:none;background:#004e78;color:#e6f6ff;border:1px solid #5cc8ff;border-radius:8px;padding:2px 6px;font-size:11px;transform:translate(-50%,-100%);white-space:nowrap}
  .pin.sel{background:#0ea5e9;color:#00111c;border-color:#8be4ff}
  .toolbar{position:sticky; top:0; z-index:4; display:flex; gap:10px; align-items:center; padding:8px 12px; background:#07101c; border-bottom:1px solid #0b2540}
  .stage{position:relative;padding:12px}
  canvas{display:block;background:#fff;box-shadow:0 0 0 1px #0b2540;margin-top:16px}
  .cross{position:absolute;pointer-events:none;border-left:1px solid #ef4444;border-top:1px solid #ef4444;width:22px;height:22px;transform:translate(-11px,-11px)}
  .err{background:#3b1d1d;border:1px solid #7a2b2b;color:#ffdcdc;padding:8px;border-radius:8px;margin:8px 0;display:none;white-space:pre-wrap}
  .hint{color:#9fb4cf;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>PDF 1:1 좌표 매핑 스튜디오</h1>
  <div>· 1pt = 1px · PDF 원본 좌표 · ↑↓←→ 미세 이동 · JSON import/export</div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div class="row">
        <label>PDF URL</label>
        <input id="pdfUrl" type="text" placeholder="/template.pdf" value="/template.pdf" style="flex:1">
        <button id="btnLoadUrl" class="primary">불러오기</button>
      </div>
      <div class="row">
        <label>로컬 PDF</label>
        <input id="pdfFile" type="file" accept="application/pdf">
        <button id="btnLoadFile">로컬 불러오기</button>
      </div>
      <div class="hint">※ 서버에 /template.pdf 가 없으면 URL 불러오기는 실패합니다. 그 경우 로컬 불러오기를 사용하세요.</div>
      <div id="err" class="err"></div>
    </div>

    <div class="card">
      <div class="row">
        <label>page</label><input id="page" type="number" value="1">
        <label>size</label><input id="size" type="number" value="10">
        <label>key</label><input id="key" type="text" placeholder="예: birth">
      </div>
      <div class="row">
        <button id="arm" class="primary">캔버스 클릭으로 좌표 찍기</button>
        <button id="export">JSON 내보내기</button>
        <input id="fileJson" type="file" accept=".json" style="display:none">
        <button id="import">가져오기</button>
      </div>
      <div class="row">
        <label>선택 X</label><input id="selX" type="number">
        <label>Y</label><input id="selY" type="number">
        <button id="applyXY">적용</button>
      </div>
      <div class="row">
        <button id="nUp">↑ 1pt</button><button id="nDn">↓ 1pt</button>
        <button id="nLt">← 1pt</button><button id="nRt">→ 1pt</button>
      </div>
    </div>

    <div class="card">
      <div>체크박스 vmap</div>
      <div class="row">
        <label>opt</label><input id="optKey" type="text" placeholder="join_type:new">
        <label>x</label><input id="optX" type="number">
        <label>y</label><input id="optY" type="number">
        <label>size</label><input id="optSize" type="number" value="11">
        <label>page</label><input id="optPage" type="number" value="1">
        <button id="addOpt">추가</button>
      </div>
    </div>

    <div class="card">
      <div>고정 라벨 (fixed_flags)</div>
      <div class="row">
        <label>label</label><input id="fixLabel" type="text" placeholder="국제전화차단">
        <label>x</label><input id="fixX" type="number">
        <label>y</label><input id="fixY" type="number">
        <label>size</label><input id="fixSize" type="number" value="10">
        <label>page</label><input id="fixPage" type="number" value="1">
        <button id="addFix">추가</button>
      </div>
    </div>
  </aside>

  <main>
    <div class="toolbar">
      <button id="prev">◀ 이전</button>
      <div id="pageInfo">Page 0 / 0</div>
      <button id="next">다음 ▶</button>
      <div style="flex:1"></div>
      <div>좌표: <span id="cursor">- , -</span></div>
    </div>
    <div id="stage" class="stage">
      <canvas id="canvas" width="595" height="842"></canvas>
      <div id="cross" class="cross" style="display:none"></div>
    </div>
  </main>
</div>

<!-- PDF.js (라이브러리 + 워커 모두 명시) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // 워커 경로를 반드시 지정 (지정 안 하면 캔버스가 안 뜨고 콘솔에만 에러 나오는 경우 多)
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  }
</script>

<script>
(function(){
  let pdfDoc=null, curPage=0, total=0;
  const c=document.getElementById('canvas'), ctx=c.getContext('2d'), stage=document.getElementById('stage');
  const cursor=document.getElementById('cursor'), cross=document.getElementById('cross');
  const err=document.getElementById('err');
  const pins=[]; let armed=false, selectedIndex=-1;

  const $=s=>document.querySelector(s);
  function showErr(msg){ err.style.display='block'; err.textContent=String(msg||'Unknown error'); console.error(msg); }
  function clearErr(){ err.style.display='none'; err.textContent=''; }
  function setInfo(){ $("#pageInfo").textContent=`Page ${curPage} / ${total}`; }

  async function loadPdfFromUrl(url){
    try{
      clearErr();
      if(!url){ showErr('PDF URL이 비어있습니다.'); return; }
      const loading=window['pdfjsLib'].getDocument({url});
      pdfDoc=await loading.promise;
      total=pdfDoc.numPages; curPage=1;
      await render(curPage); setInfo();
    }catch(e){ showErr('PDF 로드 실패: '+(e&&e.message?e.message:e)); }
  }
  async function loadPdfFromFile(file){
    try{
      clearErr();
      if(!file){ showErr('PDF 파일을 선택해 주세요.'); return; }
      const arr=new Uint8Array(await file.arrayBuffer());
      const loading=window['pdfjsLib'].getDocument({data:arr});
      pdfDoc=await loading.promise;
      total=pdfDoc.numPages; curPage=1;
      await render(curPage); setInfo();
    }catch(e){ showErr('로컬 PDF 로드 실패: '+(e&&e.message?e.message:e)); }
  }
  async function render(n){
    try{
      if(!pdfDoc){ showErr('먼저 PDF를 불러오세요.'); return; }
      const p=await pdfDoc.getPage(n);
      const vp=p.getViewport({scale:1}); // 1:1
      c.width=Math.round(vp.width); c.height=Math.round(vp.height);
      await p.render({canvasContext:ctx,viewport:vp}).promise;
      drawPins();
    }catch(e){ showErr('렌더링 오류: '+(e&&e.message?e.message:e)); }
  }

  function drawPins(){
    stage.querySelectorAll('.pin').forEach(n=>n.remove());
    pins.forEach((p,i)=>{
      if(p.page!==curPage) return;
      const el=document.createElement('div');
      el.className='pin'+(i===selectedIndex?' sel':'');
      el.style.left=p.x+'px'; el.style.top=p.y+'px';
      el.textContent = p.type==='v' ? `✓ ${p.key}` :
                       p.type==='fix' ? `[${p.label}]` :
                       p.key;
      stage.appendChild(el);
    });
  }

  // Mouse helpers
  c.addEventListener('mousemove',e=>{
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    cursor.textContent=`${x}, ${y}`; cross.style.left=x+'px'; cross.style.top=y+'px'; cross.style.display='block';
  });
  c.addEventListener('mouseleave',()=>cross.style.display='none');

  // Place pin
  c.addEventListener('click',e=>{
    if(!armed) return;
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    const key=$("#key").value.trim()||'field'; const size=+$("#size").value||10; const page=+$("#page").value||curPage||1;
    pins.push({type:'text', key, x,y,size,page});
    selectedIndex=pins.length-1; armed=false; $("#arm").textContent='캔버스 클릭으로 좌표 찍기';
    drawPins();
  });

  // Select nearest
  stage.addEventListener('click',e=>{
    const r=c.getBoundingClientRect(); const x=Math.round(e.clientX-r.left), y=Math.round(e.clientY-r.top);
    let best=-1, bestD=Infinity;
    pins.forEach((p,i)=>{ if(p.page!==curPage) return; const dx=p.x-x, dy=p.y-y; const d=dx*dx+dy*dy; if(d<bestD){best=i; bestD=d;} });
    if(best>=0){ selectedIndex=best; $("#selX").value=pins[best].x; $("#selY").value=pins[best].y; drawPins(); }
  }, true);

  // Nudge
  function nudge(dx,dy){ if(selectedIndex<0) return; const p=pins[selectedIndex]; p.x+=dx; p.y+=dy; $("#selX").value=p.x; $("#selY").value=p.y; drawPins(); }
  $("#nUp").addEventListener('click',()=>nudge(0,-1)); $("#nDn").addEventListener('click',()=>nudge(0,1));
  $("#nLt").addEventListener('click',()=>nudge(-1,0)); $("#nRt").addEventListener('click',()=>nudge(1,0));
  window.addEventListener('keydown',e=>{ if(e.key==='ArrowUp') nudge(0,-1); if(e.key==='ArrowDown') nudge(0,1); if(e.key==='ArrowLeft') nudge(-1,0); if(e.key==='ArrowRight') nudge(1,0); });

  // Apply X/Y
  $("#applyXY").addEventListener('click',()=>{ if(selectedIndex<0) return; const p=pins[selectedIndex]; p.x=+$("#selX").value||p.x; p.y=+$("#selY").value||p.y; drawPins(); });

  // Import / Export
  $("#import").addEventListener('click',()=>$("#fileJson").click());
  $("#fileJson").addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const text=await f.text(); const obj=JSON.parse(text);
      pins.length=0;
      if(obj.fields){ for(const [k,v] of Object.entries(obj.fields)){
        const base=(v.source && v.source[0]) || k.replace(/_p\\d+(_\\d+)?$/,'');
        pins.push({type:(v.type==='fixed'?'fix':'text'), key:base, x:+v.x, y:+v.y, size:+(v.size||10), page:+(v.page||1)});
      }}
      if(obj.vmap){ for(const [k,v] of Object.entries(obj.vmap)){
        pins.push({type:'v', key:k, x:+v.x, y:+v.y, size:+(v.size||11), page:+(v.page||1)});
      }}
      if(obj.fixed_flags && obj.fixed_flags.intl_roaming_block){
        for(const v of obj.fixed_flags.intl_roaming_block){
          pins.push({type:'fix', label:v.label||'적용', x:+v.x, y:+v.y, size:+(v.size||10), page:+(v.page||1)});
        }
      }
      drawPins(); alert('가져오기 완료');
    }catch(e){ showErr('JSON 파싱 오류: '+(e&&e.message?e.message:e)); }
  });

  $("#export").addEventListener('click',()=>{
    const fields={}, vmap={}, fixed={intl_roaming_block:[]};
    pins.forEach((p,idx)=>{
      if(p.type==='v') vmap[p.key]={x:p.x,y:p.y,size:p.size,page:p.page};
      else if(p.type==='fix') fixed.intl_roaming_block.push({label:p.label||'적용',x:p.x,y:p.y,size:p.size,page:p.page});
      else { const key=`${(p.key||'field')}_p${p.page}_${idx+1}`; fields[key]={x:p.x,y:p.y,size:p.size,page:p.page,source:[p.key||'field'],type:'text'}; }
    });
    const json={ fields, vmap, fixed_flags: fixed };
    const blob=new Blob([JSON.stringify(json,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='KT_mapping_legacy_names.json'; a.click();
  });

  // Buttons
  $("#btnLoadUrl").addEventListener('click',()=>loadPdfFromUrl($("#pdfUrl").value||'/template.pdf'));
  $("#btnLoadFile").addEventListener('click',()=>{ const f=$("#pdfFile").files[0]; if(!f) return alert('PDF 파일을 선택하세요.'); loadPdfFromFile(f); });

  // 기본 자동 로드는 하지 않음(경로 미존재 시 빈화면 이슈 방지)
  setInfo();
})();
</script>
</body>
</html>
