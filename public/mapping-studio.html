<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KT 폼 좌표 매핑 스튜디오 (옵션 체크박스 지원)</title>
<style>
  :root { --bg:#0f172a; --ink:#e5e7eb; --panel:#111827; --line:#334155; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; color:var(--ink); background:var(--bg); }
  header { display:flex; gap:12px; align-items:center; padding:10px; background:#0b1220; position:sticky; top:0; z-index:10; }
  header input, header select, header button { font-size:14px; padding:6px 8px; border-radius:8px; border:1px solid var(--line); background:var(--panel); color:var(--ink); }
  header button.primary { background:#2563eb; border-color:#2563eb; }
  #wrap { display:grid; grid-template-columns: 1fr 380px; height: calc(100vh - 58px); }
  #viewer { overflow:auto; background:#0b1220; display:flex; justify-content:center; }
  #sidebar { border-left:1px solid var(--line); padding:12px; overflow:auto; background:#0b1220; }
  #pdfCanvas { background:#fff; margin:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex:1 }
  .item { display:flex; gap:6px; align-items:center; padding:6px 0; border-bottom:1px dashed #24304a; }
  .item input[type="number"] { width:80px; }
  .badge { font-size:12px; padding:2px 6px; background:#eef2ff; color:#3730a3; border-radius:999px; }
  .chip { font-size:11px; padding:2px 6px; background:#dbeafe; color:#1e3a8a; border-radius:6px; }
  .overlay { position:absolute; left:0; top:0; right:0; bottom:0; }
  .cross { position:absolute; width:12px; height:12px; pointer-events:none; }
  .cross:before, .cross:after { content:""; position:absolute; background:red; }
  .cross:before { left:-6px; right:-6px; top:0; bottom:0; height:1px; }
  .cross:after  { top:-6px; bottom:-6px; left:0; right:0; width:1px; }
  .label { position:absolute; background:rgba(255,255,255,.92); border:1px solid #fca5a5; color:#111; font-size:11px; padding:2px 4px; border-radius:4px; transform:translate(10px,6px); white-space:nowrap; }
  h3 { margin:8px 0 6px; }
  small.hint { color:#a3a3a3 }
</style>
</head>
<body>
<header>
  <div class="row">
    <label>PDF 경로
      <input id="pdfUrl" value="/template.pdf" style="width:280px"/>
    </label>
    <label>페이지
      <input id="page" type="number" value="1" min="1" style="width:64px"/>
    </label>
    <label>줌
      <input id="zoom" type="number" value="120" min="10" max="400" style="width:72px"/>%
    </label>
    <button id="load" class="primary">불러오기</button>
    <span class="spacer"></span>
    <button id="exportBtn">매핑 JSON 내보내기</button>
    <input id="importFile" type="file" accept="application/json" style="display:none"/>
    <button id="importBtn">가져오기</button>
  </div>
</header>

<div id="wrap">
  <div id="viewer">
    <div style="position:relative">
      <canvas id="pdfCanvas"></canvas>
      <div class="overlay" id="overlay"></div>
    </div>
  </div>
  <aside id="sidebar">
    <h3>필드 배치 <span class="badge" id="countBadge">0</span></h3>

    <div class="row" style="margin-bottom:8px;">
      <label>필드
        <select id="fieldSelect">
          <optgroup label="일반 텍스트">
            <option>apply_date</option>
            <option>subscriber_name</option><option>birth</option><option>gender</option>
            <option>address</option><option>subscriber_phone</option><option>wish4</option>
            <option>port_number</option><option>prevcarrier</option><option>sim_serial</option>
            <option>usim_fee</option><option>pref_langs</option><option>pay_method</option>
            <option>holder_bank</option><option>pay_birth_bank</option><option>bank_name</option>
            <option>bank_account</option><option>holder_card</option><option>card_company</option>
            <option>card_number</option><option>card_exp_year</option><option>card_exp_month</option>
            <option>intl_block</option><option>roaming_block</option>
          </optgroup>
          <optgroup label="체크박스(옵션형)">
            <option>join_type</option>
            <option>gender_cb</option>
            <option>prevcarrier_cb</option>
            <option>prefsms</option>
            <option>method</option>
          </optgroup>
        </select>
      </label>

      <label>옵션(체크박스용)
        <input id="optionInput" placeholder="예: new / port / M / F / SK / LG / MVNO / EN ..." style="width:180px"/>
      </label>

      <label>크기
        <input id="sizeInput" type="number" value="10" min="6" max="24" style="width:64px"/>
      </label>

      <button id="addField">추가</button>
    </div>

    <small class="hint">※ 체크박스는 <b>필드 + 옵션</b> 조합(예: <span class="chip">join_type + new</span>)으로 각각 좌표를 찍어주세요. 클릭하면 항목이 추가됩니다.</small>

    <div id="list" style="margin-top:10px;"></div>
  </aside>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const $ = sel => document.querySelector(sel);
const overlay = $("#overlay");
const canvas = $("#pdfCanvas");
const ctx = canvas.getContext("2d");
let pdfDoc = null, scale = 1.2, currentPage = 1;

let items = []; // {key, option?, x, y, size, page}

/* ---------- PDF 렌더링 ---------- */
function ptToPx(pt){ return pt * (96/72); }
function pxToPt(px){ return px * (72/96); }

async function render(){
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(currentPage);
  const viewport = page.getViewport({ scale });
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport }).promise;
  drawOverlay();
}

function drawOverlay(){
  overlay.innerHTML = "";
  items.filter(it => it.page === currentPage).forEach(it => {
    const xPx = ptToPx(it.x * scale);
    const yPx = canvas.height - ptToPx(it.y * scale);
    const cross = document.createElement("div");
    cross.className = "cross";
    cross.style.left = xPx + "px";
    cross.style.top  = yPx + "px";
    const lab = document.createElement("div");
    lab.className = "label";
    lab.textContent = it.option ? `${it.key}:${it.option} (x:${it.x}, y:${it.y}, s:${it.size})` : `${it.key} (x:${it.x}, y:${it.y}, s:${it.size})`;
    cross.appendChild(lab);
    overlay.appendChild(cross);
  });
}

async function loadPdf(){
  const url = $("#pdfUrl").value.trim();
  const zoom = parseInt($("#zoom").value, 10) || 120;
  scale = zoom / 100;
  const loadingTask = window['pdfjsLib'].getDocument(url);
  pdfDoc = await loadingTask.promise;
  currentPage = Math.min(Math.max(parseInt($("#page").value,10)||1,1), pdfDoc.numPages);
  await render();
}

overlay.addEventListener("click", (e) => {
  const r = canvas.getBoundingClientRect();
  const xPx = e.clientX - r.left;
  const yPx = e.clientY - r.top;
  const xPt = Math.round(pxToPt(xPx) / scale);
  const yPt = Math.round((canvas.height - pxToPt(yPx)) / scale);

  const key = $("#fieldSelect").value;
  const option = ($("#optionInput").value || "").trim(); // 체크박스면 옵션 필수
  const size = parseInt($("#sizeInput").value,10) || 10;

  const optionFields = new Set(["join_type","gender_cb","prevcarrier_cb","prefsms","method"]);
  if (optionFields.has(key) && !option) {
    alert("체크박스(옵션형)는 '옵션'을 입력하세요. 예: new / port / M / F / SK / LG / MVNO / EN ...");
    return;
  }

  const item = { key, option: option || null, x: xPt, y: yPt, size, page: currentPage };
  items.push(item);
  appendItemRow(item);
  drawOverlay();
});

/* ---------- 사이드바 목록 ---------- */
function appendItemRow(item){
  const row = document.createElement("div");
  row.className = "item";
  row.innerHTML = `
    <span class="badge">${item.key}${item.option ? " : " + item.option : ""}</span>
    <label>x:<input type="number" value="${item.x}" style="width:70px"/></label>
    <label>y:<input type="number" value="${item.y}" style="width:70px"/></label>
    <label>size:<input type="number" value="${item.size}" style="width:60px"/></label>
    <label>p:<input type="number" value="${item.page}" style="width:52px"/></label>
    <button>삭제</button>
  `;
  const inputs = row.querySelectorAll("input");
  const delBtn = row.querySelector("button");
  inputs[0].oninput = () => { item.x = parseInt(inputs[0].value||"0",10); drawOverlay(); };
  inputs[1].oninput = () => { item.y = parseInt(inputs[1].value||"0",10); drawOverlay(); };
  inputs[2].oninput = () => { item.size = parseInt(inputs[2].value||"10",10); drawOverlay(); };
  inputs[3].oninput = () => { item.page = parseInt(inputs[3].value||"1",10); drawOverlay(); };
  delBtn.onclick  = () => { items = items.filter(it => it !== item); row.remove(); drawOverlay(); updateCount(); };
  $("#list").appendChild(row);
  updateCount();
}

$("#addField").onclick = () => {
  const key = $("#fieldSelect").value;
  const option = ($("#optionInput").value || "").trim();
  const size = parseInt($("#sizeInput").value,10)||10;
  const item = { key, option: option || null, x: 100, y: 100, size, page: currentPage };
  items.push(item);
  appendItemRow(item);
  drawOverlay();
};

function updateCount(){ $("#countBadge").textContent = items.length; }

/* ---------- import / export ---------- */
$("#exportBtn").onclick = () => {
  const fields = {};
  const byKey = {};
  for (const it of items) {
    if (!byKey[it.key]) byKey[it.key] = [];
    byKey[it.key].push(it);
  }
  for (const [key, arr] of Object.entries(byKey)) {
    const optionArr = arr.filter(x => x.option);
    if (optionArr.length > 0) {
      const options = {};
      for (const o of optionArr) options[o.option] = { x:o.x, y:o.y, size:o.size, page:o.page };
      fields[key] = { page: optionArr[0].page || 1, options };
    } else {
      const a = arr[0];
      fields[key] = { x:a.x, y:a.y, size:a.size, page:a.page, source:[key] };
      if (key === "apply_date") fields[key].format = "date:yyyy.MM.dd";
      if (key === "intl_block") fields[key].const = "적용";
      if (key === "roaming_block") fields[key].const = "적용";
    }
  }
  const blob = new Blob([JSON.stringify({fields}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "KT_mapping_legacy_names.json";
  a.click();
};

$("#importBtn").onclick = () => $("#importFile").click();
$("#importFile").onchange = async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const text = await f.text();
  try {
    const obj = JSON.parse(text);
    items = []; $("#list").innerHTML = "";
    if (obj && obj.fields) {
      for (const [key, cfg] of Object.entries(obj.fields)) {
        if (cfg.options) {
          for (const [opt, pos] of Object.entries(cfg.options)) {
            const it = { key, option: opt, x: pos.x||0, y: pos.y||0, size: pos.size||10, page: pos.page||cfg.page||1 };
            items.push(it); appendItemRow(it);
          }
        } else {
          const it = { key, option: null, x: cfg.x||0, y: cfg.y||0, size: cfg.size||10, page: cfg.page||1 };
          items.push(it); appendItemRow(it);
        }
      }
    }
    drawOverlay();
  } catch (err) { alert("JSON 파싱 실패: " + err.message); }
};

/* ---------- 초기 로드 ---------- */
$("#load").onclick = loadPdf;
$("#page").onchange = render;
$("#zoom").onchange = loadPdf;
window.addEventListener("load", loadPdf);
</script>
</body>
</html>
